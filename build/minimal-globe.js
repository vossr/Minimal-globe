(()=>{"use strict";var t,e="undefined"!=typeof Float32Array?Float32Array:Array;function i(t,i,s){var h=new e(3);return h[0]=t,h[1]=i,h[2]=s,h}function s(t){return t*Math.PI/180}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)}),t=new e(3),e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0);const h={tileToLatLon(t,e,i){const s=Math.pow(2,t),h=e/s*360-180;return{lat:180*Math.atan(Math.sinh(Math.PI*(1-2*i/s)))/Math.PI,lon:h}},tileDimensions(t){const e=Math.pow(2,t);return{height:180*(Math.atan(Math.sinh(Math.PI*(1-0/e)))-Math.atan(Math.sinh(Math.PI*(1-2/e))))/Math.PI,width:360/e}},getTileCorners(t,e,i){const{height:s,width:h}=this.tileDimensions(t);return{upperLeft:this.tileToLatLon(t,e,i),upperRight:this.tileToLatLon(t,e+1,i),lowerLeft:this.tileToLatLon(t,e,i+1),lowerRight:this.tileToLatLon(t,e+1,i+1)}},latLonAltToECEF(t,e,h){const r=1/298.257223563,n=r*(2-r),a=s(t),o=s(e),l=6378137/Math.sqrt(1-n*Math.pow(Math.sin(a),2)),c=(l+h)*Math.cos(a)*Math.cos(o),d=(l+h)*Math.cos(a)*Math.sin(o);return i(c,((1-n)*l+h)*Math.sin(a),-d)}};function r(){var t=new e(4);return e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}r(),function(){var t=new e(2);e!=Float32Array&&(t[0]=0,t[1]=0)}();var n,a,o,l,c,d,u,f,g,w,v,p=function(t,e,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!s:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(t):s?s.value:e.get(t)},E=function(t,e,i,s,h){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!h)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!h:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?h.call(t,i):h?h.value=i:e.set(t,i),i};class T{constructor(t,e=0,i=0,s=0,h=0,r=0){n.add(this),o.set(this,4),l.set(this,19),c.set(this,[]),d.set(this,0),this.renderer=t,this.z=e,this.x=i,this.y=s,this.isRight=h,this.isDown=r,this.children=[null,null,null,null],this.img=null,this.squareMesh=null,this.imageUrl=`https://tile.openstreetmap.org/${e}/${i}/${s}.png`,p(this,n,"m",u).call(this),p(this,n,"m",f).call(this)}delete(){this.squareMesh.delete(),this.squareMesh=null}deleteChildNodes(){var t;for(let e=0;e<4;e++){let i=this.children[e];null!=i&&(null===(t=this.children[e])||void 0===t||t.deleteChildNodes(),i.delete(),this.children[e]=null)}}renderQuadTree(t){var e,i;E(this,d,p(this,n,"m",v).call(this,t),"f");var s=0;for(let t=0;t<4;t++)this.children[t]&&(null===(e=this.children[t])||void 0===e?void 0:e.squareMesh)&&(null===(i=this.children[t])||void 0===i?void 0:i.squareMesh.textureLoaded)&&(s+=1);if(s<4)this.renderer.drawSquareMesh(this.squareMesh);else for(let e=0;e<4;e++)this.children[e]&&this.children[e].renderQuadTree(t)}update(){this.z<p(this,l,"f")&&(p(this,d,"f")>.4?p(this,n,"m",g).call(this):p(this,d,"f")<.01&&this.z>p(this,o,"f")&&this.deleteChildNodes());for(let t=0;t<4;t++)this.children[t]&&this.children[t].update()}}function m(){var t=new e(16);return e!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function M(t,e,i){var s=e[0],h=e[1],r=e[2],n=e[3],a=e[4],o=e[5],l=e[6],c=e[7],d=e[8],u=e[9],f=e[10],g=e[11],w=e[12],v=e[13],p=e[14],E=e[15],T=i[0],m=i[1],M=i[2],A=i[3];return t[0]=T*s+m*a+M*d+A*w,t[1]=T*h+m*o+M*u+A*v,t[2]=T*r+m*l+M*f+A*p,t[3]=T*n+m*c+M*g+A*E,T=i[4],m=i[5],M=i[6],A=i[7],t[4]=T*s+m*a+M*d+A*w,t[5]=T*h+m*o+M*u+A*v,t[6]=T*r+m*l+M*f+A*p,t[7]=T*n+m*c+M*g+A*E,T=i[8],m=i[9],M=i[10],A=i[11],t[8]=T*s+m*a+M*d+A*w,t[9]=T*h+m*o+M*u+A*v,t[10]=T*r+m*l+M*f+A*p,t[11]=T*n+m*c+M*g+A*E,T=i[12],m=i[13],M=i[14],A=i[15],t[12]=T*s+m*a+M*d+A*w,t[13]=T*h+m*o+M*u+A*v,t[14]=T*r+m*l+M*f+A*p,t[15]=T*n+m*c+M*g+A*E,t}function A(t,e,i,s){var h,r,n,a,o,l,c,d,u,f,g,w,v,p,E,T,m,M,A,y,R,L,_,x,P=s[0],b=s[1],D=s[2],U=Math.hypot(P,b,D);return U<1e-6?null:(P*=U=1/U,b*=U,D*=U,h=Math.sin(i),n=1-(r=Math.cos(i)),a=e[0],o=e[1],l=e[2],c=e[3],d=e[4],u=e[5],f=e[6],g=e[7],w=e[8],v=e[9],p=e[10],E=e[11],T=P*P*n+r,m=b*P*n+D*h,M=D*P*n-b*h,A=P*b*n-D*h,y=b*b*n+r,R=D*b*n+P*h,L=P*D*n+b*h,_=b*D*n-P*h,x=D*D*n+r,t[0]=a*T+d*m+w*M,t[1]=o*T+u*m+v*M,t[2]=l*T+f*m+p*M,t[3]=c*T+g*m+E*M,t[4]=a*A+d*y+w*R,t[5]=o*A+u*y+v*R,t[6]=l*A+f*y+p*R,t[7]=c*A+g*y+E*R,t[8]=a*L+d*_+w*x,t[9]=o*L+u*_+v*x,t[10]=l*L+f*_+p*x,t[11]=c*L+g*_+E*x,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)}a=T,o=new WeakMap,l=new WeakMap,c=new WeakMap,d=new WeakMap,n=new WeakSet,u=function(){var t=this.z+1,e=2*this.x,i=2*this.y;const s=[];for(let r=0;r<=1;r++)for(let n=0;n<=1;n++){const a=h.getTileCorners(t,e+n,i+r);s.push(h.latLonAltToECEF(a.lowerLeft.lat,a.lowerLeft.lon,0),h.latLonAltToECEF(a.lowerRight.lat,a.lowerRight.lon,0),h.latLonAltToECEF(a.upperLeft.lat,a.upperLeft.lon,0),h.latLonAltToECEF(a.upperRight.lat,a.upperRight.lon,0))}E(this,c,s,"f"),this.squareMesh=this.renderer.addMapTile(this.imageUrl,p(this,c,"f"))},f=function(){const t=[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1}];if(this.z+1<=p(this,o,"f"))for(let e=0;e<4;e++)if(null==this.children[e]){const i=2*this.x+t[e].x,s=2*this.y+t[e].y;this.children[e]=new a(this.renderer,this.z+1,i,s,t[e].x,t[e].y)}},g=function(){const t=[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1}];for(let e=0;e<4;e++)if(null==this.children[e]){const i=2*this.x+t[e].x,s=2*this.y+t[e].y;this.children[e]=new a(this.renderer,this.z+1,i,s,t[e].x,t[e].y)}},w=function(t,e,i){return.5*Math.abs(t[0]*(e[1]-i[1])+e[0]*(i[1]-t[1])+i[0]*(t[1]-e[1]))},v=function(t){const i=[];return p(this,c,"f").forEach((s=>{const h=function(t,i,s,h){var r=new e(4);return r[0]=t,r[1]=i,r[2]=s,r[3]=1,r}(s[0],s[1],s[2]),n=r();!function(t,e,i){var s=e[0],h=e[1],r=e[2],n=e[3];t[0]=i[0]*s+i[4]*h+i[8]*r+i[12]*n,t[1]=i[1]*s+i[5]*h+i[9]*r+i[13]*n,t[2]=i[2]*s+i[6]*h+i[10]*r+i[14]*n,t[3]=i[3]*s+i[7]*h+i[11]*r+i[15]*n}(n,h,t);const a=function(t,i){var s=new e(2);return s[0]=t,s[1]=i,s}(n[0]/n[3],n[1]/n[3]);i.push(a)})),p(this,n,"m",w).call(this,i[0],i[1],i[2])+p(this,n,"m",w).call(this,i[2],i[1],i[3])};var y,R,L,_,x,P,b,D,U,F,I,S,X,k,C,W,B,N,Y,O,q=function(t,e,i,s){return new(i||(i=Promise))((function(h,r){function n(t){try{o(s.next(t))}catch(t){r(t)}}function a(t){try{o(s.throw(t))}catch(t){r(t)}}function o(t){var e;t.done?h(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(n,a)}o((s=s.apply(t,e||[])).next())}))},z=function(t,e,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!s:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(t):s?s.value:e.get(t)},G=function(t,e,i,s,h){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!h)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!h:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?h.call(t,i):h?h.value=i:e.set(t,i),i};class Z{constructor(t,e,i){y.add(this),this.textureLoaded=!1,R.set(this,null),L.set(this,void 0),_.set(this,null),this.gl=t,this.vertices=new Float32Array([...i[0],...i[1],...i[2],...i[2],...i[1],...i[3],...i[4],...i[5],...i[6],...i[6],...i[5],...i[7],...i[8],...i[9],...i[10],...i[10],...i[9],...i[11],...i[12],...i[13],...i[14],...i[14],...i[13],...i[15]]),z(this,y,"m",x).call(this),G(this,L,this.gl.getExtension("EXT_texture_filter_anisotropic")||this.gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this.gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),"f"),z(this,y,"m",P).call(this,e)}delete(){z(this,_,"f")&&(this.gl.deleteBuffer(z(this,_,"f")),G(this,_,null,"f")),z(this,R,"f")&&(this.gl.deleteTexture(z(this,R,"f")),G(this,R,null,"f"))}bind(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,z(this,_,"f")),this.gl.bindTexture(this.gl.TEXTURE_2D,z(this,R,"f"))}}R=new WeakMap,L=new WeakMap,_=new WeakMap,y=new WeakSet,x=function(){G(this,_,this.gl.createBuffer(),"f"),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,z(this,_,"f")),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.vertices,this.gl.STATIC_DRAW)},P=function(t){G(this,R,this.gl.createTexture(),"f"),this.gl.bindTexture(this.gl.TEXTURE_2D,z(this,R,"f"));const e=new Image;e.src=t,e.crossOrigin="anonymous",e.onload=()=>{this.gl.bindTexture(this.gl.TEXTURE_2D,z(this,R,"f")),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE);const t=this.gl.RGBA,i=this.gl.RGBA,s=this.gl.UNSIGNED_BYTE;this.gl.texImage2D(this.gl.TEXTURE_2D,0,t,i,s,e),z(this,y,"m",b).call(this,e.width,e.height),this.textureLoaded=!0}},b=function(t,e){const i=t=>!(t&t-1);if(i(t)&&i(e)?(this.gl.generateMipmap(this.gl.TEXTURE_2D),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_LINEAR)):this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),z(this,L,"f")){const t=this.gl.getParameter(z(this,L,"f").MAX_TEXTURE_MAX_ANISOTROPY_EXT);this.gl.texParameterf(this.gl.TEXTURE_2D,z(this,L,"f").TEXTURE_MAX_ANISOTROPY_EXT,t)}};class H{constructor(t,e){if(D.add(this),this.canvas=null,this.gl=null,U.set(this,null),F.set(this,void 0),I.set(this,void 0),S.set(this,null),X.set(this,void 0),this.drawArraysAsLines=!1,k.set(this,void 0),C.set(this,void 0),W.set(this,void 0),this.canvas=t,this.controls=e,this.gl=this.canvas?this.canvas.getContext("webgl2",{antialias:!0}):null,this.drawScene=this.drawScene.bind(this),G(this,X,Date.now(),"f"),!this.gl)throw console.error("WebGL not supported"),"WebGL not supported";z(this,D,"m",B).call(this),this.rootNode=new T(this)}addMapTile(t,e){return new Z(this.gl,t,e)}initRenderer(){return q(this,void 0,void 0,(function*(){G(this,U,yield z(this,D,"m",O).call(this),"f"),G(this,F,this.gl.getAttribLocation(z(this,U,"f"),"aVertexPosition"),"f"),G(this,I,this.gl.getAttribLocation(z(this,U,"f"),"aTextureCoord"),"f"),G(this,S,this.gl.createBuffer(),"f"),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,z(this,S,"f")),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,.5,.5,.5,0,0,0,0,.5,.5,.5,0,.5,.5,1,.5,.5,0,.5,0,1,.5,1,0,0,1,.5,1,0,.5,0,.5,.5,1,.5,.5,.5,1,1,1,.5,.5,.5,.5,1,1,1,.5]),this.gl.STATIC_DRAW)}))}drawSquareMesh(t){this.gl.useProgram(z(this,U,"f")),this.gl.enableVertexAttribArray(z(this,F,"f")),t.bind(),this.gl.vertexAttribPointer(z(this,F,"f"),3,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(z(this,I,"f")),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,z(this,S,"f")),this.gl.vertexAttribPointer(z(this,I,"f"),2,this.gl.FLOAT,!1,0,0),this.gl.uniformMatrix4fv(this.gl.getUniformLocation(z(this,U,"f"),"uModelMatrix"),!1,z(this,k,"f")),this.gl.uniformMatrix4fv(this.gl.getUniformLocation(z(this,U,"f"),"uViewMatrix"),!1,z(this,C,"f")),this.gl.uniformMatrix4fv(this.gl.getUniformLocation(z(this,U,"f"),"uProjectionMatrix"),!1,z(this,W,"f")),this.drawArraysAsLines?this.gl.drawArrays(this.gl.LINE_LOOP,0,24):this.gl.drawArrays(this.gl.TRIANGLES,0,24)}tick(){this.rootNode.update()}drawScene(){z(this,D,"m",B).call(this),this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.gl.enable(this.gl.DEPTH_TEST),G(this,k,m(),"f"),this.controls.spaceClick&&(this.drawArraysAsLines=!this.drawArraysAsLines),A(z(this,k,"f"),z(this,k,"f"),this.controls.userPitch/500,[1,0,0]),A(z(this,k,"f"),z(this,k,"f"),this.controls.userYaw/500,[0,1,0]),G(this,C,m(),"f");const t=i(0,0,-1*(this.controls.userZoom+.99)*6378137);!function(t,e,i){var s,h,r,n,a,o,l,c,d,u,f,g,w=i[0],v=i[1],p=i[2];e===t?(t[12]=e[0]*w+e[4]*v+e[8]*p+e[12],t[13]=e[1]*w+e[5]*v+e[9]*p+e[13],t[14]=e[2]*w+e[6]*v+e[10]*p+e[14],t[15]=e[3]*w+e[7]*v+e[11]*p+e[15]):(s=e[0],h=e[1],r=e[2],n=e[3],a=e[4],o=e[5],l=e[6],c=e[7],d=e[8],u=e[9],f=e[10],g=e[11],t[0]=s,t[1]=h,t[2]=r,t[3]=n,t[4]=a,t[5]=o,t[6]=l,t[7]=c,t[8]=d,t[9]=u,t[10]=f,t[11]=g,t[12]=s*w+a*v+d*p+e[12],t[13]=h*w+o*v+u*p+e[13],t[14]=r*w+l*v+f*p+e[14],t[15]=n*w+c*v+g*p+e[15])}(z(this,C,"f"),z(this,C,"f"),t),G(this,W,m(),"f");const e=s(90),h=this.canvas.clientWidth/this.canvas.clientHeight;!function(t,e,i,s,h){var r,n=1/Math.tan(e/2);t[0]=n/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=n,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=h&&h!==1/0?(r=1/(s-h),t[10]=(h+s)*r,t[14]=2*h*s*r):(t[10]=-1,t[14]=-2*s)}(z(this,W,"f"),e,h,500,63781370);const r=m();M(r,z(this,W,"f"),z(this,C,"f")),M(r,r,z(this,k,"f")),this.rootNode.renderQuadTree(r)}}U=new WeakMap,F=new WeakMap,I=new WeakMap,S=new WeakMap,X=new WeakMap,k=new WeakMap,C=new WeakMap,W=new WeakMap,D=new WeakSet,B=function(){const t=this.canvas.clientWidth*window.devicePixelRatio,e=this.canvas.clientHeight*window.devicePixelRatio;this.canvas.width===t&&this.canvas.height===e||(this.canvas.width=t,this.canvas.height=e,this.gl.viewport(0,0,this.canvas.width,this.canvas.height))},N=function(t){return q(this,void 0,void 0,(function*(){try{const e=yield fetch(t);if(!e.ok)throw new Error("Network response was not ok");return yield e.text()}catch(t){throw console.error("There was a problem with the fetch operation:",t),t}}))},Y=function(t,e){const i=this.gl.createShader(e);return this.gl.shaderSource(i,t),this.gl.compileShader(i),this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS)?i:(console.error("An error occurred compiling the shaders: "+this.gl.getShaderInfoLog(i)),this.gl.deleteShader(i),null)},O=function(){return q(this,void 0,void 0,(function*(){const t=yield z(this,D,"m",N).call(this,window.location.href+"globe/texture_vertex.glsl"),e=yield z(this,D,"m",N).call(this,window.location.href+"globe/texture_frag.glsl"),i=z(this,D,"m",Y).call(this,t,this.gl.VERTEX_SHADER),s=z(this,D,"m",Y).call(this,e,this.gl.FRAGMENT_SHADER),h=this.gl.createProgram();return this.gl.attachShader(h,i),this.gl.attachShader(h,s),this.gl.linkProgram(h),this.gl.getProgramParameter(h,this.gl.LINK_STATUS)?h:(console.error("Unable to initialize the shader program: "+this.gl.getProgramInfoLog(h)),null)}))};class j{constructor(t){this.canvas=t,this.userYaw=0,this.userPitch=0,this.userZoom=2,this.spaceDown=!1,this.spaceClick=!1,this.isDragging=!1,this.prevX=0,this.prevY=0,this.attachEventListeners()}tickReset(){this.spaceClick=!1}attachEventListeners(){this.canvas.addEventListener("contextmenu",(t=>{t.preventDefault()})),this.canvas.addEventListener("mousedown",(t=>this.handleMouseDown(t))),this.canvas.addEventListener("mousemove",(t=>this.handleMouseMove(t))),this.canvas.addEventListener("mouseup",(t=>this.handleMouseUp(t))),this.canvas.addEventListener("wheel",(t=>this.handleScroll(t))),document.addEventListener("keydown",(t=>this.handleKeyboard(t,"down"))),document.addEventListener("keyup",(t=>this.handleKeyboard(t,"up")))}handleKeyboard(t,e){"Space"===t.code&&("down"==e?(0==this.spaceDown&&(this.spaceClick=!0),this.spaceDown=!0):this.spaceDown=!1)}handleScroll(t){const e=.001*t.deltaY;let i=this.userZoom*Math.pow(e+1,1.5);var s;s=i,i=Math.max(0,Math.min(4e5,s)),this.userZoom=i}handleMouseDown(t){this.isDragging=!0,this.prevX=t.pageX,this.prevY=t.pageY}handleMouseMove(t){if(this.isDragging){const e=t.pageX-this.prevX,i=t.pageY-this.prevY,s=.5;this.userYaw+=e*(this.userZoom*s),this.userPitch+=i*(this.userZoom*s),this.prevX=t.pageX,this.prevY=t.pageY}}handleMouseUp(t){this.isDragging&&(this.isDragging=!1)}}var K=function(t,e,i,s){return new(i||(i=Promise))((function(h,r){function n(t){try{o(s.next(t))}catch(t){r(t)}}function a(t){try{o(s.throw(t))}catch(t){r(t)}}function o(t){var e;t.done?h(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(n,a)}o((s=s.apply(t,e||[])).next())}))};class V{static create(){return K(this,void 0,void 0,(function*(){const t=new V;return yield t.initialize(),t}))}constructor(){this.canvas=null,this.controls={},this.renderer={}}initialize(){return K(this,void 0,void 0,(function*(){if(this.canvas=document.getElementById("renderCanvas"),!this.canvas)throw new Error("Canvas element not found!");this.controls=new j(this.canvas),this.renderer=new H(this.canvas,this.controls),yield this.renderer.initRenderer()}))}mainLoop(){this.renderer.tick(),this.renderer.drawScene(),this.controls.tickReset(),requestAnimationFrame((()=>this.mainLoop()))}}V.create().then((t=>{t.mainLoop()})).catch((t=>{console.error("Error in global catch:",t)}))})();